---
description: QB Trading System ì „ìš© ì½”ë”© ê·œì¹™ ë° ì•„í‚¤í…ì²˜ ê°€ì´ë“œë¼ì¸
globs: **/*.py, **/*.ts, **/*.tsx, **/*.js, **/*.jsx
alwaysApply: true
---

# ê°€ì¥ ì¤‘ìš”í•œ ê·œì¹™

ëª¨ë“  ëª…ë ¹ì€

1. ê°„ëµí•œ ê³„íš ì„¤ëª…
2. **í—ˆë½** ë° **ê²€í† ** ë°›ê¸°
3. ê²€í† ê°€ ì™„ë£Œëœ ê±´ì— í•œí•´ì„œ ì½”ë“œ ìˆ˜ì •.
4. í•œë²ˆì— í•œ íŒŒì¼ì„ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ë‹¨ê³„ì ìœ¼ë¡œ ìƒê°.

ì´ ë£°ì„ ì§€í‚¤ê³  ì‹œì‘í•´.

# QB Trading System ì½”ë”© ê·œì¹™

QB Trading Systemì€ **ì‹¤ì‹œê°„ íŠ¸ë ˆì´ë”©**ì„ ìœ„í•œ **ì´ë²¤íŠ¸ ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜**ì…ë‹ˆë‹¤. ì‹¤ì œ ê¸ˆìœµ ê±°ë˜ë¥¼ ì²˜ë¦¬í•˜ë¯€ë¡œ **ì‹ ë¢°ì„±, ì„±ëŠ¥, ë³´ì•ˆ**ì´ ìµœìš°ì„ ì…ë‹ˆë‹¤.

## ğŸ¯ **í•µì‹¬ ì„¤ê³„ ì›ì¹™**

### **KISS (Keep It Simple, Stupid)**

- **ë³µì¡ì„±ì„ ì¤„ì´ê³  ë‹¨ìˆœí•˜ê²Œ ìœ ì§€**
- ì½”ë“œë¥¼ ìµœëŒ€í•œ ë‹¨ìˆœí•˜ê²Œ ì‘ì„±í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì´ê³  ìœ ì§€ë³´ìˆ˜ë¥¼ ìš©ì´í•˜ê²Œ í•¨
- ê³¼ë„í•œ ì¶”ìƒí™”ë‚˜ ë³µì¡í•œ ë””ìì¸ íŒ¨í„´ ì§€ì–‘

### **YAGNI (You Ain't Gonna Need It)**

- **í˜„ì¬ í•„ìš”í•œ ê¸°ëŠ¥ë§Œ êµ¬í˜„**
- ë¯¸ë˜ì— í•„ìš”í•  ìˆ˜ë„ ìˆëŠ” ê¸°ëŠ¥ì€ êµ¬í˜„í•˜ì§€ ì•ŠìŒ
- ë¶ˆí•„ìš”í•œ ê¸°ëŠ¥ ì¶”ê°€ë¥¼ ë°©ì§€í•˜ê³  ê°œë°œ ì‹œê°„ì„ ì ˆì•½

### **DRY (Don't Repeat Yourself)**

- **ì½”ë“œ ì¤‘ë³µì„ í”¼í•˜ê³  ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ë“œ ì‘ì„±**
- ê³µí†µ ë¡œì§ì€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë‚˜ ë² ì´ìŠ¤ í´ë˜ìŠ¤ë¡œ ì¶”ì¶œ
- ì„¤ì •ì´ë‚˜ ìƒìˆ˜ëŠ” ì¤‘ì•™í™”ëœ config íŒŒì¼ì—ì„œ ê´€ë¦¬

## ğŸ—ï¸ **ì•„í‚¤í…ì²˜ ê·œì¹™**

### **ì´ë²¤íŠ¸ ê¸°ë°˜ ì„¤ê³„**

- **ëª¨ë“  ì—”ì§„ ê°„ í†µì‹ ì€ Redis Pub/Sub ì´ë²¤íŠ¸ë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰**
- ì§ì ‘ì ì¸ í•¨ìˆ˜ í˜¸ì¶œì´ë‚˜ ê°ì²´ ì°¸ì¡° ê¸ˆì§€
- ì´ë²¤íŠ¸ ì´ë¦„ì€ `snake_case`ë¡œ ëª…ëª…: `market_data_received`, `trading_signal`, `order_executed`

```python
# âœ… DO: ì´ë²¤íŠ¸ ê¸°ë°˜ í†µì‹ 
await event_bus.publish('market_data_received', {
    'symbol': 'AAPL',
    'price': 150.0,
    'timestamp': datetime.now()
})

# âŒ DON'T: ì§ì ‘ í˜¸ì¶œ
technical_analyzer.update_indicators(market_data)
```

### **ì—”ì§„ ë…ë¦½ì„±**

- **ê° ì—”ì§„ì€ ì™„ì „íˆ ë…ë¦½ì ìœ¼ë¡œ ë™ì‘**í•´ì•¼ í•¨
- ë‹¤ë¥¸ ì—”ì§„ì˜ ë‚´ë¶€ êµ¬í˜„ì— ì˜ì¡´í•˜ì§€ ì•ŠìŒ
- ì—”ì§„ë³„ ì„¤ì •ì€ í™˜ê²½ë³€ìˆ˜ë‚˜ config íŒŒì¼ë¡œ ë¶„ë¦¬

### **ë¹„ë™ê¸° ì²˜ë¦¬**

- **ëª¨ë“  I/O ì‘ì—…ì€ ë¹„ë™ê¸°(`async/await`)ë¡œ ì²˜ë¦¬**
- ë¸”ë¡œí‚¹ ì‘ì—…ìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ ë°©ì§€
- ë™ì‹œì„±ì„ í™œìš©í•œ íš¨ìœ¨ì ì¸ ë°ì´í„° ì²˜ë¦¬

```python
# âœ… DO: ë¹„ë™ê¸° ì²˜ë¦¬
async def collect_market_data(symbol: str) -> MarketData:
    async with aiohttp.ClientSession() as session:
        async with session.get(f"/api/market/{symbol}") as response:
            return await response.json()

# âŒ DON'T: ë™ê¸° ì²˜ë¦¬
def collect_market_data(symbol: str) -> MarketData:
    response = requests.get(f"/api/market/{symbol}")
    return response.json()
```

## ğŸ”’ **ì•ˆì „ì„± ë° ì‹ ë¢°ì„±**

### **ì—ëŸ¬ ì²˜ë¦¬**

- **ëª¨ë“  ì™¸ë¶€ API í˜¸ì¶œì—ëŠ” ì¬ì‹œë„ ë¡œì§ê³¼ íšŒë¡œ ì°¨ë‹¨ê¸° íŒ¨í„´ ì ìš©**
- ì˜ˆì™¸ëŠ” êµ¬ì²´ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ì ì ˆí•œ ë¡œê¹… ìˆ˜í–‰
- ì‹œìŠ¤í…œ ì „ì²´ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ëŠ” ì˜ˆì™¸ëŠ” ì ˆëŒ€ ë°œìƒì‹œí‚¤ì§€ ì•ŠìŒ

```python
# âœ… DO: í¬ê´„ì  ì—ëŸ¬ ì²˜ë¦¬
async def execute_order(order: Order) -> OrderResult:
    try:
        result = await broker_api.place_order(order)
        logger.info(f"Order executed successfully: {order.id}")
        return result
    except BrokerAPIError as e:
        logger.error(f"Broker API error: {e}")
        await event_bus.publish('order_failed', {'order_id': order.id, 'error': str(e)})
        return OrderResult(status='failed', error=str(e))
    except Exception as e:
        logger.critical(f"Unexpected error in order execution: {e}")
        # ë¹„ìƒ ì •ì§€ ì‹œê·¸ë„ ë°œì†¡
        await event_bus.publish('emergency_stop', {'reason': f'Order execution error: {e}'})
        return OrderResult(status='error', error='System error occurred')
```

### **ë°ì´í„° ê²€ì¦**

- **ëª¨ë“  ì…ë ¥ ë°ì´í„°ëŠ” Pydantic ëª¨ë¸ë¡œ ê²€ì¦**
- ê¸ˆìœµ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ ì¶”ê°€ ê²€ì¦ ë¡œì§
- ì˜ëª»ëœ ë°ì´í„°ë¡œ ì¸í•œ ê±°ë˜ ì˜¤ë¥˜ ë°©ì§€

```python
# âœ… DO: Pydantic ëª¨ë¸ ê²€ì¦
from pydantic import BaseModel, validator
from decimal import Decimal

class MarketData(BaseModel):
    symbol: str
    price: Decimal
    volume: int
    timestamp: datetime

    @validator('price')
    def price_must_be_positive(cls, v):
        if v <= 0:
            raise ValueError('Price must be positive')
        return v

    @validator('symbol')
    def symbol_format(cls, v):
        if not v.isalpha() or len(v) > 10:
            raise ValueError('Invalid symbol format')
        return v.upper()
```

### **ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§**

- **ëª¨ë“  ì¤‘ìš”í•œ ì‘ì—…ì€ êµ¬ì¡°í™”ëœ ë¡œê¹…ìœ¼ë¡œ ê¸°ë¡**
- ë¡œê·¸ ë ˆë²¨ì„ ì ì ˆíˆ í™œìš©: DEBUG, INFO, WARNING, ERROR, CRITICAL
- íŠ¸ë ˆì´ë”© ê´€ë ¨ ì‘ì—…ì€ ë³„ë„ì˜ audit ë¡œê·¸ë¡œ ê´€ë¦¬

```python
# âœ… DO: êµ¬ì¡°í™”ëœ ë¡œê¹…
import structlog

logger = structlog.get_logger()

await logger.info(
    "Order placed",
    order_id=order.id,
    symbol=order.symbol,
    quantity=order.quantity,
    price=order.price,
    strategy=order.strategy_name
)
```

## ğŸ’° **ê¸ˆìœµ ë°ì´í„° ì²˜ë¦¬**

### **ì •ë°€ë„ ë³´ì¥**

- **ëª¨ë“  ê¸ˆì•¡ ê³„ì‚°ì€ `Decimal` íƒ€ì… ì‚¬ìš©**
- `float` íƒ€ì…ì€ ì •ë°€ë„ ì˜¤ì°¨ë¡œ ì¸í•´ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
- ìˆ˜ìˆ˜ë£Œ ê³„ì‚° ì‹œ ì†Œìˆ˜ì  ì²˜ë¦¬ë¥¼ ëª…í™•íˆ ì •ì˜

```python
# âœ… DO: Decimal ì‚¬ìš©
from decimal import Decimal, ROUND_HALF_UP

price = Decimal('150.25')
quantity = Decimal('100')
total = price * quantity  # Decimal('15025.00')

# ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼)
commission = (total * Decimal('0.0025')).quantize(
    Decimal('0.01'),
    rounding=ROUND_HALF_UP
)

# âŒ DON'T: float ì‚¬ìš©
price = 150.25
quantity = 100
total = price * quantity  # ì •ë°€ë„ ì˜¤ì°¨ ê°€ëŠ¥
```

### **ì‹œê°„ ì²˜ë¦¬**

- **ëª¨ë“  ì‹œê°„ì€ UTC ê¸°ì¤€ìœ¼ë¡œ ì €ì¥í•˜ê³  ì²˜ë¦¬**
- í•œêµ­ ì‹œê°„ í‘œì‹œê°€ í•„ìš”í•œ ê²½ìš°ë§Œ ë³€í™˜
- ê±°ë˜ ì‹œê°„ ê²€ì¦ ë¡œì§ í•„ìˆ˜ í¬í•¨

```python
# âœ… DO: UTC ì‹œê°„ ì‚¬ìš©
from datetime import datetime, timezone
import pytz

utc_now = datetime.now(timezone.utc)
kst_tz = pytz.timezone('Asia/Seoul')
kst_time = utc_now.astimezone(kst_tz)

# ê±°ë˜ ì‹œê°„ ê²€ì¦
def is_trading_hours(dt: datetime) -> bool:
    """í•œêµ­ ì£¼ì‹ì‹œì¥ ê±°ë˜ì‹œê°„ í™•ì¸"""
    kst_time = dt.astimezone(pytz.timezone('Asia/Seoul'))
    weekday = kst_time.weekday()
    hour = kst_time.hour
    minute = kst_time.minute

    # í‰ì¼ 09:00-15:30
    if weekday < 5 and (9 <= hour < 15 or (hour == 15 and minute <= 30)):
        return True
    return False
```

## ğŸ§ª **í…ŒìŠ¤íŠ¸ ê·œì¹™**

### **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**

- **ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ í•„ìˆ˜**
- ê¸ˆìœµ ê³„ì‚° ë¡œì§ì€ 100% ì»¤ë²„ë¦¬ì§€ ëª©í‘œ
- ì´ë²¤íŠ¸ ê¸°ë°˜ í†µì‹ ì€ í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ê²€ì¦

### **ì‹¤ìš©ì  í…ŒìŠ¤íŠ¸ ë„êµ¬ ê´€ë¦¬**

- **ì—°ê²° í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” `tools/` ë””ë ‰í† ë¦¬ì— ë³´ê´€**
- **í—¬ìŠ¤ì²´í¬ ë„êµ¬ëŠ” ì§€ì†ì ìœ¼ë¡œ í™œìš© ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€**
- **ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±**

```python
# âœ… DO: ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ë„êµ¬ êµ¬ì¡°
tools/
â”œâ”€â”€ health_checks/
â”‚   â”œâ”€â”€ redis_connection_test.py
â”‚   â”œâ”€â”€ postgres_connection_test.py
â”‚   â””â”€â”€ kis_api_test.py
â”œâ”€â”€ performance/
â”‚   â”œâ”€â”€ redis_benchmark.py
â”‚   â””â”€â”€ data_processing_benchmark.py
â””â”€â”€ data_validation/
    â”œâ”€â”€ market_data_validator.py
    â””â”€â”€ trading_signal_validator.py

# ì‹¤í–‰ ë°©ë²•:
# python tools/health_checks/redis_connection_test.py
# python tools/performance/redis_benchmark.py --duration=60s
```

### **í…ŒìŠ¤íŠ¸ ë„êµ¬ ë„¤ì´ë° ì»¨ë²¤ì…˜**

- **ì—°ê²° í…ŒìŠ¤íŠ¸**: `{component}_connection_test.py`
- **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**: `{component}_benchmark.py`
- **ë°ì´í„° ê²€ì¦**: `{data_type}_validator.py`
- **ëª¨ë‹ˆí„°ë§ ë„êµ¬**: `{component}_monitor.py`

### **ëª¨í‚¹ ì „ëµ**

- **ì™¸ë¶€ APIëŠ” ëª¨í‚¹í•˜ì—¬ í…ŒìŠ¤íŠ¸**
- ì‹¤ì œ ê±°ë˜ì†Œ API í˜¸ì¶œì€ í…ŒìŠ¤íŠ¸ì—ì„œ ê¸ˆì§€
- í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ë°ì´í„°ëŠ” ì‹¤ì œì™€ ìœ ì‚¬í•œ í˜•íƒœë¡œ êµ¬ì„±

```python
# âœ… DO: ì™¸ë¶€ API ëª¨í‚¹
@pytest.fixture
def mock_broker_api():
    with patch('qb.api.kis_client.KISClient') as mock:
        mock.place_order.return_value = {
            'order_id': 'TEST123',
            'status': 'filled',
            'executed_price': Decimal('150.00')
        }
        yield mock

async def test_order_execution(mock_broker_api):
    engine = OrderEngine()
    result = await engine.execute_order(test_order)
    assert result.status == 'filled'
    mock_broker_api.place_order.assert_called_once()
```

## ğŸš€ **ì„±ëŠ¥ ìµœì í™”**

### **ë©”ëª¨ë¦¬ ê´€ë¦¬**

- **ëŒ€ìš©ëŸ‰ ë°ì´í„°ëŠ” ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬**
- Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ (ëª©í‘œ: 20-25MB)
- ë¶ˆí•„ìš”í•œ ë°ì´í„° ë³´ê´€ ê¸°ê°„ ìµœì†Œí™”

### **ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”**

- **ì ì ˆí•œ ì¸ë±ìŠ¤ ì„¤ì •ìœ¼ë¡œ ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”**
- ì‹œê³„ì—´ ë°ì´í„°ëŠ” TimescaleDB í•˜ì´í¼í…Œì´ë¸” í™œìš©
- ë°°ì¹˜ ì‚½ì…ìœ¼ë¡œ ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬

```python
# âœ… DO: ë°°ì¹˜ ì‚½ì…
async def save_market_data_batch(data_list: List[MarketData]):
    async with db_session() as session:
        await session.execute(
            insert(market_data_table),
            [data.dict() for data in data_list]
        )
        await session.commit()
```

## ğŸ” **ë³´ì•ˆ ê·œì¹™**

### **API í‚¤ ê´€ë¦¬**

- **ëª¨ë“  API í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬**
- ì½”ë“œì— í•˜ë“œì½”ë”© ì ˆëŒ€ ê¸ˆì§€
- `.env` íŒŒì¼ì€ `.gitignore`ì— í¬í•¨

### **ì…ë ¥ ê²€ì¦**

- **ëª¨ë“  ì™¸ë¶€ ì…ë ¥ì€ sanitization í›„ ì‚¬ìš©**
- SQL ì¸ì ì…˜ ë°©ì§€ë¥¼ ìœ„í•œ íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
- ì‚¬ìš©ì ì…ë ¥ì— ëŒ€í•œ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê²€ì¦

## ğŸ“ **ì½”ë“œ êµ¬ì¡° ë° ë„¤ì´ë°**

### **íŒŒì¼ êµ¬ì¡°**

```
qb/
â”œâ”€â”€ engines/           # 8ê°œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì—”ì§„
â”‚   â”œâ”€â”€ data_collector/
â”‚   â”œâ”€â”€ technical_analyzer/
â”‚   â”œâ”€â”€ strategy_engine/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ models/           # Pydantic ëª¨ë¸
â”œâ”€â”€ database/         # DB ìŠ¤í‚¤ë§ˆ ë° ì—°ê²°
â”œâ”€â”€ utils/            # ê³µí†µ ìœ í‹¸ë¦¬í‹°
â”œâ”€â”€ config/           # ì„¤ì • ê´€ë¦¬
â””â”€â”€ tests/            # í…ŒìŠ¤íŠ¸ ì½”ë“œ
```

### **ë„¤ì´ë° ì»¨ë²¤ì…˜**

- **í´ë˜ìŠ¤**: PascalCase (`DataCollector`, `OrderEngine`)
- **í•¨ìˆ˜/ë³€ìˆ˜**: snake_case (`collect_data`, `order_id`)
- **ìƒìˆ˜**: UPPER_SNAKE_CASE (`MAX_ORDER_SIZE`, `API_TIMEOUT`)
- **ì´ë²¤íŠ¸**: snake_case (`market_data_received`, `order_executed`)

### **íƒ€ì… íŒíŠ¸**

- **ëª¨ë“  í•¨ìˆ˜ì— íƒ€ì… íŒíŠ¸ í•„ìˆ˜ ì‘ì„±**
- ë³µì¡í•œ íƒ€ì…ì€ TypeAlias í™œìš©
- Optional, Union ë“±ì„ ëª…í™•íˆ í‘œì‹œ

```python
# âœ… DO: ëª…í™•í•œ íƒ€ì… íŒíŠ¸
from typing import Optional, List, Dict, Union
from decimal import Decimal

OrderID = str
Price = Decimal
Quantity = int

async def place_order(
    symbol: str,
    price: Price,
    quantity: Quantity,
    order_type: str = "limit"
) -> Optional[OrderID]:
    """ì£¼ë¬¸ì„ ì‹¤í–‰í•˜ê³  ì£¼ë¬¸ IDë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    pass
```

## ğŸ“Š **ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼**

### **í—¬ìŠ¤ì²´í¬**

- **ê° ì—”ì§„ì€ í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ ì œê³µ**
- ì£¼ê¸°ì ì¸ ìƒíƒœ í™•ì¸ ë° ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜
- ì¥ì•  ì‹œ ì¦‰ì‹œ ì•Œë¦¼ ë°œì†¡

### **ì„±ëŠ¥ ì§€í‘œ**

- **í•µì‹¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ëª¨ë‹ˆí„°ë§**
- ì‘ë‹µ ì‹œê°„, ì²˜ë¦¬ëŸ‰, ì—ëŸ¬ìœ¨ ì¶”ì 
- ë¹„ì •ìƒì ì¸ íŒ¨í„´ ê°ì§€ ì‹œ ìë™ ì•Œë¦¼

---

ì´ ê·œì¹™ë“¤ì€ **QB Trading Systemì˜ ì•ˆì •ì„±ê³¼ ì„±ëŠ¥**ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ ê¸°ë³¸ ê°€ì´ë“œë¼ì¸ì…ë‹ˆë‹¤.
ëª¨ë“  ê°œë°œìëŠ” ì´ ê·œì¹™ì„ ìˆ™ì§€í•˜ê³  ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.
